<!DOCTYPE html><html lang=en> <head><meta charset=utf-8><title>Using udp-link to enhance TCP connections stability :: Vorakl's notes</title><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=robots content=all><link href=https://vorakl.com/articles/udp-link/ rel=canonical><meta name=description content="A UDP transport layer implementation for proxying TCP connections"><link rel=stylesheet href="https://vorakl.com/theme/bootstrap-pygments.bundle.min.css?v=1709265848"><link rel=alternate type=application/atom+xml href=https://vorakl.com/atom.xml title="Vorakl's notes"><meta name=theme-color content=#205081><link rel="shortcut icon" href="/favicon.ico?v=1709265848"><link rel=apple-touch-icon sizes=180x180 href="/favicon/apple-touch-icon.png?v=1709265848"><link rel=icon type=image/png sizes=32x32 href="/favicon/favicon-32x32.png?v=1709265848"><link rel=icon type=image/png sizes=16x16 href="/favicon/favicon-16x16.png?v=1709265848"><link rel=manifest href="/favicon/manifest.json?v=1709265848"><meta name=apple-mobile-web-app-title content="Vorakl's notes"><meta name=application-name content="Vorakl's notes"></head> <body> <div class=navbar> <div class=navbar-inner> <div class=container> <a href=https://vorakl.com/ class=brand>Vorakl's notes</a> <div class=nav-collapse> <ul class="nav pull-right"> <!-- <li class="divider-vertical"></li> --> <li><a href=https://vorakl.com/pages/reading/ >Reading</a></li> <li><a href=https://vorakl.com/pages/projects/ >Projects</a></li> <li><a href=https://vorakl.com/pages/contacts/ >Contacts</a></li> <li><a href=https://vorakl.com/pages/about/ >About</a></li> <!-- <li class="divider-vertical"></li> --> </ul> </div> </div> </div> </div> <div class=container> <div class=content> <div class=row> <div class=span12> <div class=article> <div class=content-title> <h2>Using udp-link to enhance TCP connections stability</h2> <div class="well small">on 2024-01-16 in <a href=https://vorakl.com/categories/article/ >article</a> about <a href=https://vorakl.com/tags/networking/ >networking</a> <a href=https://vorakl.com/tags/tools/ >tools</a> ~5 min read </div> <p><h3>A UDP transport layer implementation for proxying TCP connections</h3></p> </div> <div class=content><p><a class="reference internal" href=#summary>TLDR: quick summary of the article</a></p> <div class=line-block> <div class=line><br></div> </div> <p>I recently discovered <a class="reference external" href=https://github.com/pgul/udp-link>udp-link</a>, a very useful project for all those guys like me who spend most of their working time in terminals over ssh connections. The tool implements the UDP transport layer, which acts as a proxy for TCP connections. It's designed to be integrated into the OpenSSH configuration. However, with a little trick, it can also be used as a general-purpose TCP-over-UDP proxy. <em>udp-link</em> greatly improves the stability of connections over unreliable networks that experience packet loss and intermittent connectivity. It also includes an IP roaming, which allows TCP connections to remain alive even if an IP address changes.</p> <div class=line-block> <div class=line><br></div> </div> <p><em>udp-link</em> is written in C by <a class="reference external" href=https://gul.kiev.ua>Pavel Gulchuk</a>, who has a lot of experience in running unreliable networks. Despite being a young project, the version <a class="reference external" href=https://github.com/pgul/udp-link/releases/tag/v0.4>v0.4</a> shows pretty stable results. Once configured, you won't think about it anymore. Unless you're surprised every time when ssh connections don't brake, survive a laptop's sleep mode and connections to different Wi-Fi networks.</p> <div class=line-block> <div class=line><br></div> </div> <p>In the current architecture, the client-side tool takes data on the standard input and sends it to the server side via UDP. The same copy of the tool takes that data from the network on a specific UDP port and sends it to a TCP service (local or remote from a server-side perspective). The destination TCP service and a UDP listening port on the server side can be specified on the client at startup. Otherwise, a TCP connection will be established with <em>127.0.0.1:22</em> and a port is randomly chosen from a predefined port range. Note that the server firewall should allow the traffic to this port range on UDP. The TCP service can also reside on a different host, if the server side is used as a jumpbox. I consider it one of the greatest features that <em>udp-link</em> uses a zero server-side configuration, all configuration tweaks happen only on the client side.</p> <div class=line-block> <div class=line><br></div> </div> <p><em>udp-link</em> on the server side does not run as a daemon or listen on a UDP port all the time. Instead, the client initiates the invocation of the tool on the on the server side in listening mode with a randomly generated key. This key is used to authenticate the client connection. This is done on demand by establishing a normal ssh connection over TCP with the server side, temporarily, just to run the tool in the background. The connection is then closed. This is where a secure client authentication comes into play. <em>udp-link</em> <strong>doesn't encrypt the transferred data</strong>, which is useful when is used together with ssh because it avoids a double encryption, but needs to be kept that in mind when used with other configurations.</p> <div class=line-block> <div class=line><br></div> </div> <p>To start using <em>udp-link</em>, you need to clone the repository, compile, and install the tool on both sides</p> <div class=highlight><pre><span></span>git clone https://github.com/pgul/udp-link.git
<span class=nb>cd</span>  udp-link
make
sudo make install
</pre></div> <div class=line-block> <div class=line><br></div> </div> <p>and then make an ssh connection on the client side by executing a command similar to</p> <div class=highlight><pre><span></span>ssh -o <span class=nv>ProxyCommand</span><span class=o>=</span><span class=s2>&quot;udp-link %r@%h&quot;</span> user@host
</pre></div> <div class=line-block> <div class=line><br></div> </div> <p><em>ProxyCommand</em> allows ssh to send all its data to the standard input of a specified command instead of to a TCP connection. This command will be responsible for sending the data to a server side in some way and should eventually deliver it to a target ssh service. OpenSSH also supports a number of macros such as <em>%r</em> and <em>%p</em> which can be found in its documentation. Personally, I use ssh in a slightly different way and never send out my public ssh keys to unknown hosts. More details on this topic can be found in a great article '<a href=https://tim.siosm.fr/blog/2023/01/13/openssh-key-management/ class="reference external">OpenSSH client side key management for better privacy and security</a>', written by Timoth√©e Ravier. So I'm actively using <em>ssh_config</em> files, where I specify all connection-specific details, such as hostname, username, ssh key, and in this case, <strong>ProxyCommand</strong>. My typical <em>ssh_config</em> file looks something like this</p> <div class=highlight><pre><span></span>Host some-server
    user some-user
    hostname some-IP
    IdentityFile ~/.ssh/ssh-some-server.key
    ProxyCommand udp-link some-IP

Host some-IP
    user some-user
    IdentityFile ~/.ssh/ssh-some-server.key

Host *
    IdentitiesOnly yes
    IdentityFile /dev/null
    GSSAPIAuthentication no
    HostbasedAuthentication no
    SendEnv no
</pre></div> <div class=line-block> <div class=line><br></div> </div> <p>and then to connect I just run</p> <div class=highlight><pre><span></span>ssh some-server
</pre></div> <div class=line-block> <div class=line><br></div> </div> <p>The second <strong>Host some-IP</strong> block is needed to provide a correct ssh key to a temporary ssh connection (without <em>ProxyCommand</em>) that <em>udp-link</em> establishes at the beginning of a new session. To debug the connection add <em>--debug</em> option</p> <div class=highlight><pre><span></span>ssh -o <span class=nv>ProxyCommand</span><span class=o>=</span><span class=s2>&quot;udp-link --debug some-IP&quot;</span> some-server
</pre></div> <div class=line-block> <div class=line><br></div> </div> <p>If I need to bind a connection to a specific UDP port on the server side, I initiate a connection like this</p> <div class=highlight><pre><span></span>ssh -o <span class=nv>ProxyCommand</span><span class=o>=</span><span class=s2>&quot;udp-link -b 1234 some-IP&quot;</span> some-server
</pre></div> <div class=line-block> <div class=line><br></div> </div> <p>You can also bind it to a privileged port (1-1024), but <em>udp-link</em> needs root permissions to do this, which can be achieved in a number of ways, such as making it root-owned with the setuid bit turned on on the server-side copy of a binary file.</p> <div class=highlight><pre><span></span>chown root /usr/local/bin/udp-link
chmod u+s /usr/local/bin/udp-link
</pre></div> <div class=line-block> <div class=line><br></div> </div> <p>Unlike other projects with a similar goal, e.g. <a class="reference external" href=https://github.com/mobile-shell/mosh>Mosh</a>, <em>udp-link</em> doesn't allocate a pseudo terminal, which I consider a feature, because it opens the possibility to use the tool not only for accessing remote terminals, but also for proxying any arbitrary TCP connection. However, <em>udp-link</em> cannot currently listen on a local TCP port on the client side. Fortunately, this can be worked around by adding <em>socat</em> and its exceptional ability to connect things. However, <em>socat</em> cannot be paired with <em>udp-link</em> via an unnamed pipe, because pipes provide a unidirectional interprocess communication, while here we need a bi-directional communication to get data back from the network. The trick is that <em>udp-link</em> is invoked by <em>socat</em>. Here is an example of how to open a listening <em>2525/TCP</em> port on the client side, then proxy a future TCP connection over a UDP channel to a remote host, and connect it to a <em>25/TCP</em> port on the server's localhost in debug mode</p> <div class=highlight><pre><span></span>socat TCP-LISTEN:2525 SYSTEM:<span class=s2>&quot;udp-link -t 127.0.0.1\:25 --debug some-IP&quot;</span>
</pre></div> <div class=line-block> <div class=line><br></div> </div> <p><em>udp-link</em> is a small, flexible and very useful tool. I hope to see further development, adding new features and maturing the code base.</p> <div class=line-block> <div class=line><br></div> </div> <div class=section id=summary> <h2>Summary</h2> <ul class=simple> <li><em>udp-link</em> is a tool that implements the UDP transport layer to act as a proxy for TCP connections over unreliable networks.</li> <li>It is designed to be integrated into OpenSSH configuration to improve stability of ssh connections.</li> <li>udp-link allows TCP connections to remain alive even if the IP address changes through its IP roaming feature.</li> <li>On the client side, udp-link takes data from standard input and sends it to the server side via UDP, where it is then sent to the target TCP service.</li> <li>The server side of udp-link does not run as a daemon and instead is invoked on demand by the client through a temporary SSH connection.</li> <li>Authentication is done through a randomly generated key during the temporary SSH connection.</li> <li>udp-link doesn't encrypt the transferred data, which is useful when is used together with SSH to avoid double encryption.</li> <li>Installation is done through cloning the GitHub repo, compiling, and installing on both client and server.</li> <li>All configuration is done only on the client side</li> </ul> <!-- Links --> </div> </div> </div> <div class=article style="text-align: center; font-size: 1.1em; font-style: italic"> Found a <span style="color: red; font-weight: bold">bug</span> or <span style="color: red; font-weight: bold">typo</span>? Please, send me <a href=/pages/feedback/ >feedback</a> or submit a <a href=https://github.com/vorakl/vorakl.github.io/blob/master/src.docs/content/articles/udp-link.rst>PR on Github</a>. </div> <div class=article> <div class="well small"><h5>This is my personal blog. All ideas, opinions, examples, and other information that can be found here are my own and belong entirely to me. This is the result of my personal efforts and activities at my free time. It doesn't relate to any professional work I've done and doesn't have correlations with any companies I worked for, I'm currently working, or will work in the future.</h5></div> </div> </div> </div> </div> <footer> <div class=container> <div class=row> <div class=span5> <span class=pull-left> &copy; 2024 <a href=https://vorakl.com/pages/about/ >vorakl</a> All Rights Reserved </span> </div> <div class=span7> <div class=pull-right> Powered by <a href=https://github.com/getpelican/pelican>Pelican</a> and <a href=https://github.com/vorakl/aves>Aves</a> theme </div> </div> </div> </div> </footer> </div> </body> </html>